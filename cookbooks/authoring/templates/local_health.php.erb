<?php
define('INTERNAL_SERVER_ERROR_HTTP_CODE',500);
define('SUCCESS_HTTP_CODE', 200);


$ch = curl_init();

//Is wordpress Up?

curl_setopt($ch, CURLOPT_URL, "http://localhost:<%=node['nginx']['server']['healthcheck']['listen_port']%>/<%=node['wp-authoring']['nginx']['tenantName']%>/wordpress/?rest_route=");
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
$output = curl_exec($ch);
$info   = curl_getinfo($ch);
$downstream_response = $info['http_code'];
if ($downstream_response != SUCCESS_HTTP_CODE) {
    echo "Health check Fail. Wordpress returned a ".$downstream_response;
    http_response_code($downstream_response);
    curl_close($ch);
    exit(1);
}


else if(strpos($output, "<%=node['wp-authoring']['healthcheck']['compare_string']%>") === false) {
    echo "Health Check Fail";
    http_response_code(INTERNAL_SERVER_ERROR_HTTP_CODE);
    curl_close($ch);
    exit(1);
    
}
curl_close($ch);

echo "Its an OK";
http_response_code(SUCCESS_HTTP_CODE);
?>
